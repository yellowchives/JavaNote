## JSP

### 概述

Servlet可以通过转发或重定向跳转到某个HTML文档。但HTML文档中的内容不受Servlet的控制。比如登录失败时，跳转回登录表单页面无法显示诸如“用户名或密码不正确”的错误消息，所以我们目前采用的办法是跳转到一个错误信息页面。如果通过Servlet逐行输出响应信息则会非常繁琐。

java server page：java服务器端页面。其实就是一个特殊的页面，其中即可以写html文档，又可以写java代码。**JSP本质上就是一个Servlet**。
JSP的工作模式是请求/响应模式，客户端首先发出HTTP请求，JSP程序收到请求后进行处理并返回处理结果。在一个JSP文件第1次被请求时，JSP引擎（容器）把该JSP文件转换成为一个Servlet，而这个引擎本身也是一个Servlet。

**Jsp与Servlet分工**

- Jsp本质是一个Servlet ，翻译后的文件结构为：class helloworld_jsp : HttpJspBase : HttpServlet。
- Jsp主要负责显示及获取数据，从表面上看，Jsp相对于在html中嵌入java代码：jsp=html+java。
- Servlet主要负责处理业务，从表面上看，Servlet相当于在java中嵌入html代码：Servlet=java+html。
- 总结：相比于Servlet，Jsp更加善于处理显示页面，而Servlet更善于处理业务逻辑，两种技术各有专长，所以一般我们会将Servlet和Jsp结合使用，Servlet负责业务，Jsp负责显示。

### 使用

1. JSP脚本元素：是指嵌套在<%和%>之中的一条或多条Java程序代码。主要包括以下三种类型：

   1. JSP脚本<% 代码 %>：这里写的代码会被放在service方法中，里面定义的变量都是局部变量。

   2. JSP声明<%! 代码 %>：用于在JSP页面中定义全局的变量或方法，是Servlet的成员变量或成员方法。

   3. JSP表达式<%= 代码 %>：可以是任何Java语言的完整表达式。该表达式的最终运算结果将被转换为字符串并输出到页面上。也可以用 out.println()代替。

      ```jsp
      <body>
          计算3/2=<%= 3/2 %> <%-- JSP表达式不仅可以插入网页的文本中，用于输出文本内容，也可以插入HTML标记中，用于动态设置属性值。--%>
      </body>
      ```

2. 注释

   1. JSP注释：<%-- --%> 服务器端注释，解析时将跳过这些代码，在客户端是查看源代码是看不到这些注释的。
   2. html注释：<!-- -->客户端注释，浏览器查看源代码能看到这些注释。
   3. css注释: /* 单行或者多行 */

3. JSP指令：用来设置JSP页面中的一些信息

   1. page指令：用来对页面的某些特性进行描述，如：页面的编码方式、JSP 页面采用的语言等
      格式：<%@ page 属性名1= "属性值1" 属性名2= "属性值2" ...%>
      page指令常见属性：
      <img src="D:\Program Files\Typora\Java\image\epub_35449554_194.jpg" style="zoom: 80%;" />
      注意：除了import属性外，其他的属性都只能出现一次，否则会编译失败。同时page指令的属性名称都是区分大小写的。

      ```jsp
      <%@ page contentType="text/html;charset=UTF-8" language="java"  pageEncoding="utf-8" %>
      ```

   2. include指令：在实际开发时，有时需要在JSP页面静态包含一个文件，例如HTML文件、JSP等，这时，可以通过include指令来实现。不过该指令是静态包含，也就是说被包含文件中所有内容会被原样包含到该JSP页面中，即使被包含文件中有JSP代码，在包含时也不会被编译执行。使用include指令，最终将生成一个文件，所以在被包含和包含的文件中，不能有相同名称的变量。
      格式：<%@ include file="被包含的文件地址"%>
      注意：在应用include指令进行文件包含时，为了使整个页面的层次结构不发生冲突，建议在被包含页面中将\<html>、\<body>等标记删除。因为在包含该页面的文档中已经指定了这些标签。
      top.jsp:
      
      ```jsp
      <%@ page contentType="text/html;charset=UTF-8" language="java" %>
      <div style="background-color: antiquewhite;color: blue;font-size: x-large"><%="这是标题"%>></div>
      <!-- 使用include，两个页面的page指令必须一样-->
      ```
      
      index.jsp:
      
      ```jsp
      <%@ page contentType="text/html;charset=UTF-8" pageEncoding="UTF-8" %>
      <!DOCTYPE html>
      <html>
      <head>
          <title>Hello World</title>
      </head>
      <body>
      <%@ include file="top.jsp"%>
      <h1><%= "Hello World!" %>
      </h1>
      <br/>
      <a href="hello-servlet">Hello Servlet</a>
      </body>
      </html>
      ```
      
   3. taglib：用来导入外部标签库。`<%taglib uri="" prefix=""%>`
   
4. 动作标签：形如`<jsp:xxx>`

   1. 动态包含\<jsp:include>用于向当前页面中包含其他的文件。被包含的文件可以是动态文件，也可以是静态文件。
      格式：`<jsp:Include page=“url” flush=“false|true”/>`

      1. \<jsp:include>和include指令的比较
         1. include指令通过file属性指定被包含的文件，并且file属性不支持任何表达式；\<jsp:include>动作标识通过page属性指定被包含的文件，而且page属性支持JSP表达式。
         2. 使用include指令时，被包含的文件内容会原封不动地插入包含页中，然后JSP编译器再将合成后的文件最终编译成一个Java文件；使用\<jsp:include>动作标识包含文件时，当该标识被执行时，程序会将请求转发（注意是转发，而不是请求重定向）到被包含的页面，并将执行结果输出到浏览器中，然后返回包含页继续执行后面的代码。因为服务器执行的是多个文件，所以JSP编译器会分别对这些文件进行编译。
         3. 在应用include指令包含文件时，由于被包含的文件最终会生成一个文件，所以在被包含文件、包含文件中不能有重名的变量或方法；而在应用\<jsp:include>动作标识包含文件时，由于每个文件是单独编译的，所以在被包含文件和包含文件中重名的变量和方法是不相冲突的。

   2. 请求转发标识\<jsp:forword>：可以将请求转发到其他的Web资源，和Servlet的请求转发一样。
      格式：`<jsp:forward page="url" />`

   3. 参数传递标识\<jsp:param>：可以作为其他标识的子标识，用于为其他标识传递参数。
      格式：`<jsp:param name="参数名" value="值">`

      ```jsp
      <jsp:forward page="login.jsp" />
      	<jsp:param name="username" value="zhangsan" />
      </jsp:forward>
      ```

      通过\<jsp:param>动作标识指定的参数，将以“参数名=值”的形式加入请求中。它的功能与在文件名后面直接加“？参数名=参数值一样。

### 9个内置对象

JSP提供了一些内置对象，不需要实例化就可以直接使用

1. pageContext
   - 页面域对象
   - 类型：javax.servlet.jsp.PageContext
   - 作用：
     1. 可以直接获取其他8个内置对象
     2. 域对象
   - 在Servlet中获取方式：无【导包后才能使用javax.servlet.jsp.PageContext;】
2. request
   - 请求域对象
   - 类型：javax.servlet.http.HttpServletRequest
   - 作用：与Servlet中讲解一致
     1. 获取请求参数:request.getParameter()
     2. 获取请求头
     3. 获取URL
     4. 转发:request.getRequestDispatcher().forward()
     5. 域对象:request.getAttribute()   |  request.setAttibute() ....
3. session
   - 会话域对象
   - 类型：javax.servlet.http.HttpSession
   - 在Servlet中获取方式：request.getSession()
4. application
   - 上下文域
   - 类型：javax.servlet.ServletContext
   - 作用：
     1. 获取上下文路径
     2. 获取真实路径
     3. 获取上下文初始化参数
     4. 域对象
   - 在Servlet中的获取方式：getServletContext()

5. page
   - 类型：java.lang.Object
   - 作用： java.lang.Object page = this;
6. response
   - 类型：javax.servlet.http.HttpServletResponse
   - 作用：
     1. 获取响应流，响应数据
     2. 设置响应头
     3. 重定向
7. out
   - 类型：javax.servlet.jsp.JspWriter
   - 作用：与Servlet中PrintWriter作用类似，将数据显示到页面
     - java.io.PrintWriter与javax.servlet.jsp.JspWriter都继承java.io.Wirter
8. config
   - 类型：javax.servlet.ServletConfig
   - 作用：
     1. 获取Servlet名称
     2. 获取初始化参数
     3. 获取ServletContext对象
9. exception
   - 类型： java.lang.Throwable
   - 作用：处理异常

- 总结：Jsp一共9个内置对象，但默认只有8个内置对象【其中exception内置对象，需要设置page指令中的【isErrorPage=true】时，才能提供】

### 四大域对象

域对象指的是对象有作用域。域对象可以实现数据共享。不同作用范围的域对象，共享数据的能力不一样。在Servlet规范中，一共有4个域对象。ServletContext是web应用中最大的作用域，叫application域。每个应用只有一个application域。它可以实现整个应用间的数据共享功能。Session会话域、request请求域、pageContext页面域：jsp特有

- pageContext【页面域】
  - 有效范围：在当前页面有效【离开当前页面失效】
- request【请求域】
  - 有效范围：在当前请求有效【不在当前请求失效】
    - 当前请求：指本次请求【请求路径发生变化就不在当前请求】
    - 转发请求时：是在当前请求
- session【会话域】
  - 有效范围：在当前会话有效【离开当前会话失效】
  - 当前会话：浏览器与服务器之间会话，与浏览器有关，与服务器无关。
    - 浏览器不关闭&不更换，即为当前会话
    - 关闭浏览器或更换浏览器，当前会话结束
- application【上下文域|web域】
  - 有效范围：当前web应用有效
  - web应用卸载失效【关闭服务器|服务器进程结束】

**域对象共同方法**

- 设置属性到域中：void setAttribute(String key , Object value);
- 从域中获取指定的属性：Object  getAttribute(String key);
- 移除域中指定属性：void removeAttribute(String key);

### 案例：使用JSP获取上次访问页面的时间

```jsp
<%@ page import="java.util.Date" %>
<%@ page import="java.text.SimpleDateFormat" %>
<%@ page contentType="text/html;charset=UTF-8" pageEncoding="UTF-8" %>
<!DOCTYPE html>
<html>
<head>
</head>
<body>
<%
    long lastAccessedTime = session.getLastAccessedTime();//获取上次访问时间的毫秒数
    Date date = new Date();
    date.setTime(lastAccessedTime);//将毫秒数转成日期对象
    SimpleDateFormat sdf = new SimpleDateFormat("yyyy/MM/dd HH:mm:ss");
    String str_date = sdf.format(date);//格式化日期对象
%>
<%= str_date%>
</body>
</html>
```

### JSP最佳实战-MVC模型

MVC模式：model + view + controller	模型+视图+控制器，是一种软件设计典范。

M：model，通常用于封装数据。具体的方法由普通的Java类实现, 一般起名为 xxxService. 如果要进行持久化存储, 还需要 dao 和 bean, 以便于和数据库交互.

V：view，通常用于展示数据。动态展示用jsp页面，静态数据展示用html。

C：controller，通常用于处理请求和响应。一般指的是Servlet。

![1577355748295](D:\Program Files\Typora\Java\黑马Java笔记\assets\1577355748295.png)                                                                      

## JavaBean

Java规定了标准的类定义格式，符合这种格式的Java类就是一个JavaBean。要求如下：

1. 所有属性为private
2. 提供公共的无参构造方法
3. 提供getter和setter
4. 实现serializable接口

JavaBean在Java EE开发中，通常用于封装数据，对于遵循以上写法的JavaBean组件，其它程序可以通过反射技术实例化JavaBean对象（内省机制），并且通过反射那些遵循命名规范的方法，从而获知JavaBean的属性，进而调用其属性保存数据。

所以**符合JavaBean规范的类，就算成员变量是私有的，也可以直接使用<font color="red">对象名.属性名</font>修改**。大大简化了jsp的代码。

## EL

Expression Language表达式语言。用来替换和简化jsp的表达式。

特点：

- **EL表达式用于代替JSP表达式(<%= %>)**在页面中做输出操作。
- EL表达式**仅仅用来读取数据，而不能对数据进行修改。**
- EL在得到某个数据时，会自动进行数据类型的转换。
- 使用EL表达式输出数据时，如果有则输出数据，如果为null则什么也不输出。

语法：${表达式}。注意EL用在jsp的java代码中，jQuery用在JavaScript中。EL不需要导包, 直接使用即可.

### 获取值

**获取四大域中的数据**
找到了就输出，没找到就空着，不会输出null，比较美观。

1. **el表达式只能从域对象中获取值**

2. ${域名称.键名}：从指定域中获取指定键的值
   pageContext --> pageScope
   request --> requestScope
   session --> sessionScope
   application(ServletContext) --> applicationScope

3. ${键名}：表示依次从最小的域中查找是否有该键对应的值，直到找到为止。

4. 获取参数：${param.参数名} param是EL内置的对象

5. 获取对象、List集合、Map集合的值

   1. 对象：${域名称.对象名.属性名}

      ```java
      package com.example.JSPDemo;//定义一个JavaBean类
      public class Person {   
          private String name;//属性都是私有的    
          private Date birthday;    
          public Person(){} //提供无参构造   
          //getter、setter略    
          //成员方法    
          public String getInfo() {        
              SimpleDateFormat sdf = new SimpleDateFormat("yyyy/MM/dd HH:mm:ss");       
              return name + "出生于："+sdf.format(birthday) ; }
      }
      ```

      ```jsp
      <%@ page import="com.example.JSPDemo.Person" %>
      <%@ page import="java.util.Date" %>
      <%@ page contentType="text/html;charset=UTF-8" language="java" %>
      <html>
          <head>
          </head>
          <body>
              <% //先使用java代码创建一个对象，再保存到域对象中，就可以使用EL表达式来访问了   
              Person person = new Person();    
              person.setBirthday(new Date());   
              person.setName("zhangsan");    
              request.setAttribute("p",person);//这一步是必需的，对象必须保存到域中，才可以用EL来访问 %>
              ${p.name}<br/>
              ${p.birthday}<br/>
              ${p.info}<br/><%--调用对象的getInfo()方法, 就像使用属性一样简单 --%>
          </body>
      </html>
      ```

   2. List集合：${域名称.集合名[索引]}

   3. Map集合：${域名称.集合名.key}或${域名称.集合名["key"]}

### 运算符

![](D:\Program Files\Typora\Java\image\1577782263203.png)

![](D:\Program Files\Typora\Java\image\1577782270585.png)

```jsp
<%@ page language="java" import="java.util.*" pageEncoding="UTF-8"%>
<%@ page import="com.itheima.domain.User" %>
<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
	<head>
		<title>EL两个特殊的运算符</title>
	</head>
	<body>
		<%--空运算符： empty
            功能：用于判断字符串、集合、数组对象是否为null或者长度是否为0
            ${empty list}:判断字符串、集合、数组对象是否为null或者长度为0
            ${not empty str}:表示判断字符串、集合、数组对象是否不为null 并且 长度>0
		--%>
		<% String str = null;
		  String str1 = "";
		  List<String> slist = new ArrayList<String>();
		  pageContext.setAttribute("str", str);
		  pageContext.setAttribute("str1", str1);
		  pageContext.setAttribute("slist", slist);
		%>
		${empty str}============当对象为null返回true<br/>
		${empty str1}==========当字符串为空字符串是返回true(注意：它不会调用trim()方法)<br>
		${empty slist}==========当集合中的元素是0个时，是true
		<hr/>
		<%--三元运算符 
			 条件?真:假
		--%>
		<% request.setAttribute("gender", "female"); %>
		<input type="radio" name="gender" value="male" ${gender eq "male"?"checked":""} >男
		<input type="radio" name="gender" value="female" ${gender eq "female"?"checked":""}>女
	</body>
</html>
```

### 11个内置对象

- EL域对象						对应JSP域对象
  - **pageScope**				pageContext
  - **requestScope**                            request
  - **sessionScope**                            session
  - **applicationScope**                       application
- Jsp域对象，同时通用于EL中
  - **pageContext**：可以直接获取JSP中，其他8个内置对象

- 其他6个内置对象
  - **param**：获取请求参数，与jsp中request.getParameter()作用一致。
  - paramValues：获取请求参数【多个】，与request.getParameterValues()作用一致。
  - **header**：获取请求头，与jsp中request.getHeader()作用一致。
  - headerValue：获取请求头【多个】
  - **cookie**：获取Cookie信息
  - initParam：获取上下文初始化参数，与jsp中ServletContext.getInitParameter()作用一致

- 总结：
  - jsp中  pageContext对象 = EL中 pageScope【域】 + pageContext【获取jsp中其他8个内置对象】
  - jsp中 request = El中  requestScope【域】 + param【获取请参数】 + header【获取请求头】
    - request【获取请求参数+获取请求头+获取URL+转发+域】
  - 问：如何在EL中获取URL信息？
    - 答：原生jsp的方式：`<%=request.getRequestURL()%>`
      EL的方式：`${pageContext.request.requestURL}`。需要先获取jsp的对象，然后调用期方法。

### 注意

EL没有空指针异常、没有索引越界异常、没有字符串拼接的效果

```jsp
<%@ page contentType="text/html;charset=UTF-8" language="java" %>
<html>
  <head>
    <title>EL表达式的注意事项</title>
  </head>
  <body>
    <%--EL表达式的三个没有--%>
    第一个：没有空指针异常<br/>
    <% String str = null;
       request.setAttribute("testNull",str);
    %>
    ${testNull}
    <hr/>
    第二个：没有数组下标越界<br/>
    <% String[] strs = new String[]{"a","b","c"};
       request.setAttribute("strs",strs);
    %>
    取第一个元素：${strs[0]}
    取第六个元素：${strs[5]}
    <hr/>
    第三个：没有字符串拼接<br/>
    <%--${strs[0]+strs[1]}--%>
    ${strs[0]}+${strs[1]}
  </body>
</html>
```

## JSTL

JSP Standard Tag Library: JSP标准标签库，用标签的形式写java代码。由以下5个部分组成：

JSTL共有5组标签库，需要掌握其中3种。使用标签库需要导入jar包。

- 核心标签库

  <%@ taglib prefix="c" uri="http://java.sun.com/jsp/jstl/core" %>

- 格式化标签库

  <%@ taglib prefix="fmt" uri="http://java.sun.com/jsp/jstl/fmt" %>

- 函数库

  <%@ taglib prefix="fn" uri="http://java.sun.com/jsp/jstl/functions" %>

![](D:\Program Files\Typora\Java\image\Snipaste_2021-08-25_15-46-00.jpg)

### 核心标签库

1. set：可以向域中保存变量，也可以修改变量的值
	
   1. `<c:set var="str" value="helloworld" scope="request"></c:set>`
   2. ```jsp
	<%
		Student stu = new Student("cxk",20);
		request.setAttribute("stu",stu);
	%>
	<c:set target="${requestScope.student}" property="name" value="xgk"></c:set>
	
2. if
      ```jsp
      <c:if test="${2>1}" var="flag" scope="request"><!-- test里的EL如果为TRUE，则显示标签体的内容，并把判断结果保存成变量，放到域中-->
      	2>1; 
      </c:if>
      ```
      - test 必须属性，接受boolean表达式。如果表达式为true，则显示if标签体内容，如果为false，则不显示标签体内容。

      * test属性值会结合el表达式一起使用，因为 jstl 不能使用运算符直接运算。
      * 注意：c:if标签没有else情况，想要else情况，就再定义一个c:if

3. choose:相当于java代码的switch语句

      ```jsp
      <c:set var="score" value="A" scope="session"></c:set>
      <c:choose>
          <!-- when相当于switch的case -->
          <c:when test="${sessionScope.score eq 'A' }">
              成绩优
          </c:when>
          <c:when test="${sessionScope.score eq 'B' }">
              成绩良
          </c:when>
          <c:when test="${sessionScope.score eq 'C' }">
              成绩中
          </c:when>
          <c:when test="${sessionScope.score eq 'D' }">
              成绩差
          </c:when>
          <!-- otherwise相当于default -->
          <c:otherwise>其他</c:otherwise>
      </c:choose>
      ```

4. foreach:相当于java代码的for语句

```jsp
<%-- c:forEach 它是用来遍历集合的
属性：
items：要遍历的集合
var：把当前遍历的元素放入指定的page域中。var的取值就是key,当前遍历的元素就是value
注意：它不能支持EL表达式，只能是字符串常量
begin:开始遍历的索引
end:结束遍历的索引
step：步长。i+=step
varStatus：它是一个计数器对象。里面有两个属性，一个是用于记录索引。一个是用于计数。索引是从0开始。计数是从1开始
--%>
<hr/>
<% List<String> list = new ArrayList<String>();
list.add("AAA");
list.add("BBB");
list.add("CCC");
list.add("DDD");
list.add("EEE");
list.add("FFF");
list.add("GGG");
list.add("HHH");
list.add("III");
list.add("JJJ");
list.add("KKK");
list.add("LLL");
pageContext.setAttribute("list",list);
%>
<!-- 如果有items，那就是一个增强for循环。begin从0开始，end比终止的索引大1-->
<c:forEach items="${pageScope.list}" var="s" begin="0" end="7" step="2">
    ${s}<br/>
</c:forEach>
<hr/>
<!-- 没有items，那就是一个普通for循环-->
<c:forEach begin="1" end="9" var="num">
    <a href="#">${num}</a>
</c:forEach>
<hr/>
<table>
    <th>
        <td>索引</td>
        <td>序号</td>
        <td>信息</td>
    </th>
    <c:forEach items="${list}" var="s" varStatus="vs">
        <tr>
            <td>${vs.index}</td>
            <td>${vs.count}</td>
            <td>${s}</td>
        </tr>
    </c:forEach>
</table>
```

### 其他标签库or函数库

- **格式化标签库之fmt**

  - **作用：**格式化数据，如日期、数字等

  - **属性：**

    - value：要格式化的格式化数据
    - pattern：格式化规则

  - **示例代码**

    ```jsp
    <%
        Date date = new Date();
        request.setAttribute("date",date);
    %>
    <fmt:formatDate value="${requestScope.date}" pattern="yyyy-MM-dd hh:mm:ss"></fmt:formatDate>
    ```

- **函数库**

  - **作用：**类似java中String作用

  - **示例代码**

    ```jsp
    ${fn:contains("HEllo", "he")}
    结果:false
    ```

    
